services:
  # Redis cache for Blockscout
  redis_db:
    image: redis:7-alpine
    restart: unless-stopped
    container_name: redis_db
    command: redis-server
    volumes:
      - redis-data:/data

  # PostgreSQL database for Blockscout
  db:
    image: postgres:14-alpine
    restart: unless-stopped
    container_name: blockscout_postgres_db
    environment:
      POSTGRES_PASSWORD: 'blockscout'
      POSTGRES_USER: 'blockscout'
      POSTGRES_DB: 'blockscout'
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"

  # Smart Contract Verifier Service (pin a stable tag)
  smart-contracts-verifier:
    image: ghcr.io/blockscout/smart-contract-verifier:v1.10.0
    restart: unless-stopped
    container_name: smart_contracts_verifier
    environment:
      SMART_CONTRACT_VERIFIER__SERVER__HTTP__ADDR: 0.0.0.0:8050
      SMART_CONTRACT_VERIFIER__SOLIDITY__ENABLED: "true"
      SMART_CONTRACT_VERIFIER__VYPER__ENABLED: "true"
      SMART_CONTRACT_VERIFIER__SOURCIFY__ENABLED: "true"
      SMART_CONTRACT_VERIFIER__SOURCIFY__API_URL: https://sourcify.dev/server/
    expose:
      - "8050"

  # Main Blockscout Backend Service
  blockscout:
    depends_on:
      - db
      - smart-contracts-verifier
      - redis_db
    image: blockscout/blockscout:6.9.0
    restart: unless-stopped
    container_name: blockscout
    stop_grace_period: 5m
    command: >
      sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    environment:
      # Database configuration
      DATABASE_URL: postgresql://blockscout:blockscout@db:5432/blockscout
      ECTO_USE_SSL: "false"
      POOL_SIZE: "50"
      POOL_SIZE_API: "10"

      # Network configuration - Hardhat local network
      ETHEREUM_JSONRPC_VARIANT: geth
      ETHEREUM_JSONRPC_HTTP_URL: http://host.docker.internal:8545
      ETHEREUM_JSONRPC_WS_URL: ws://host.docker.internal:8545
      NETWORK: PharmaLedger
      SUBNETWORK: Hardhat

      # Chain configuration for Hardhat
      CHAIN_ID: "31337"
      COIN: PHARMA
      COIN_NAME: "PharmaLedger Token"

      # Redis configuration
      REDIS_URL: redis://redis_db:6379

      # API / features
      API_V2_ENABLED: "true"
      MICROSERVICE_SC_VERIFIER_ENABLED: "true"
      MICROSERVICE_SC_VERIFIER_URL: http://smart-contracts-verifier:8050/
      MICROSERVICE_SC_VERIFIER_TYPE: sc_verifier
      WEBSOCKET_V2_ENABLED: "true"

      # Disable unsupported methods for Hardhat (no txpool_content spam)
      INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER: "true"
      ETHEREUM_JSONRPC_DISABLE_ARCHIVE_BALANCES: "true"
      
      # Disable internal transaction fetcher (Hardhat doesn't support debug_traceTransaction)
      INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER: "true"
      
      # Disable additional fetchers that cause block tag errors
      INDEXER_DISABLE_BLOCK_REWARD_FETCHER: "true"
      INDEXER_DISABLE_CATALOGED_TOKEN_UPDATER_FETCHER: "true"
      INDEXER_DISABLE_EMPTY_BLOCKS_SANITIZER: "false"
      
      # Start indexing from genesis block
      FIRST_BLOCK: "0"
      TRACE_FIRST_BLOCK: "0"
      
      # Enable realtime block fetcher for immediate indexing
      INDEXER_REALTIME_FETCHER_ENABLED: "true"
      INDEXER_REALTIME_FETCHER_MAX_GAP: "1000"
      
      # Optimize block indexing for faster processing
      INDEXER_CATCHUP_BLOCKS_BATCH_SIZE: "10"
      INDEXER_CATCHUP_BLOCKS_CONCURRENCY: "2"
      INDEXER_MEMORY_LIMIT: "1"
      
      # Optimize receipts fetching
      INDEXER_RECEIPTS_BATCH_SIZE: "50"
      INDEXER_RECEIPTS_CONCURRENCY: "10"
      BLOCK_TRANSFORMER: "base"
      
      # Reduce block polling interval for faster indexing (milliseconds)
      ETHEREUM_JSONRPC_TRACE_URL: http://host.docker.internal:8545
      INDEXER_BLOCK_INTERVAL: "1000"

      # Logging
      LOG_LEVEL: "error"
      EXQ_LOG_LEVEL: "error"
      ADMIN_PANEL_ENABLED: "true"

    expose:
      - "4000"
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Frontend for Blockscout
  frontend:
    depends_on:
      - blockscout
    image: ghcr.io/blockscout/frontend:v2.3.0
    restart: unless-stopped
    container_name: frontend
    expose:
      - "3000"
    volumes:
      - ./next-sitemap.config.js:/app/deploy/tools/sitemap-generator/next-sitemap.config.js:ro
    environment:
      # Public app host/port (through Nginx gateway)
      NEXT_PUBLIC_APP_HOST: localhost
      NEXT_PUBLIC_APP_PORT: 3000
      NEXT_PUBLIC_APP_PROTOCOL: http

      # API configuration - Browser should call gateway
      NEXT_PUBLIC_API_HOST: localhost
      NEXT_PUBLIC_API_PORT: 3000
      NEXT_PUBLIC_API_PROTOCOL: http
      NEXT_PUBLIC_API_BASE_PATH: "/api"
      NEXT_PUBLIC_API_WEBSOCKET_PROTOCOL: "ws"

      # Network configuration
      NEXT_PUBLIC_NETWORK_NAME: "PharmaLedger Network"
      NEXT_PUBLIC_NETWORK_SHORT_NAME: "PharmaChain"
      NEXT_PUBLIC_NETWORK_ID: 31337
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: PHARMA
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: PHARMA
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: 18
      NEXT_PUBLIC_IS_TESTNET: "true"
      
      # Feature flags to prevent errors with empty blockchain
      NEXT_PUBLIC_HIDE_INDEXING_ALERT_BLOCKS: "true"
      
      # Disable ads to prevent CORS and network errors
      NEXT_PUBLIC_AD_BANNER_PROVIDER: "none"
      NEXT_PUBLIC_AD_TEXT_PROVIDER: "none"
      
      # Disable external services that cause errors
      NEXT_PUBLIC_MIXPANEL_PROJECT_TOKEN: ""
      
      # Fix address identicon errors
      NEXT_PUBLIC_VIEWS_ADDRESS_IDENTICON_TYPE: "jazzicon"

  # Nginx Gateway - single entry point
  nginx:
    image: nginx:1.25-alpine
    container_name: gateway
    depends_on:
      - frontend
      - blockscout
    ports:
      - "3000:80"                # Explorer UI at http://localhost:3000
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro

volumes:
  postgres-data:
  redis-data:
