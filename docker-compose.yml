version: '3.8'

services:
  # Redis cache for Blockscout
  redis_db:
    image: redis:7-alpine
    restart: unless-stopped
    container_name: redis_db
    command: redis-server
    volumes:
      - redis-data:/data

  # PostgreSQL database for Blockscout
  db:
    image: postgres:14
    restart: unless-stopped
    container_name: blockscout_postgres_db
    environment:
      POSTGRES_PASSWORD: 'blockscout'
      POSTGRES_USER: 'blockscout'
      POSTGRES_DB: 'blockscout'
    volumes:
      - postgres-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"

  # Smart Contract Verifier Service
  smart-contracts-verifier:
    image: ghcr.io/blockscout/smart-contract-verifier:latest
    restart: unless-stopped
    container_name: smart_contracts_verifier
    environment:
      SMART_CONTRACT_VERIFIER__SERVER__HTTP__ADDR: 0.0.0.0:8050
      SMART_CONTRACT_VERIFIER__SERVER__GRPC__ADDR: 0.0.0.0:8051
      SMART_CONTRACT_VERIFIER__SOLIDITY__ENABLED: "true"
      SMART_CONTRACT_VERIFIER__SOLIDITY__COMPILERS_DIR: /tmp/solidity-compilers
      SMART_CONTRACT_VERIFIER__SOLIDITY__REFRESH_VERSIONS_SCHEDULE: "0 0 * * * * *"
      SMART_CONTRACT_VERIFIER__VYPER__ENABLED: "true"
      SMART_CONTRACT_VERIFIER__VYPER__COMPILERS_DIR: /tmp/vyper-compilers
      SMART_CONTRACT_VERIFIER__VYPER__REFRESH_VERSIONS_SCHEDULE: "0 0 * * * * *"
      SMART_CONTRACT_VERIFIER__SOURCIFY__ENABLED: "true"
      SMART_CONTRACT_VERIFIER__SOURCIFY__API_URL: https://sourcify.dev/server/
      SMART_CONTRACT_VERIFIER__SOURCIFY__VERIFICATION_ATTEMPTS: 3
      SMART_CONTRACT_VERIFIER__SOURCIFY__REQUEST_TIMEOUT: 10
      SMART_CONTRACT_VERIFIER__METRICS__ENABLED: "false"
      SMART_CONTRACT_VERIFIER__JAEGER__ENABLED: "false"
    ports:
      - "8050:8050"
      - "8051:8051"

  # Visualizer Service
  visualizer:
    image: ghcr.io/blockscout/visualizer:latest
    restart: unless-stopped
    container_name: visualizer
    environment:
      VISUALIZER__SERVER__HTTP__ADDR: 0.0.0.0:8052
      VISUALIZER__SERVER__GRPC__ADDR: 0.0.0.0:8053
    ports:
      - "8052:8052"
      - "8053:8053"

  # SigEth Service  
  sig-provider:
    image: ghcr.io/blockscout/sig-provider:latest
    restart: unless-stopped
    container_name: sig_provider
    environment:
      SIG_PROVIDER__SERVER__HTTP__ADDR: 0.0.0.0:8054
      SIG_PROVIDER__SERVER__GRPC__ADDR: 0.0.0.0:8055
    ports:
      - "8054:8054"
      - "8055:8055"

  # Main Blockscout Backend Service
  blockscout:
    depends_on:
      - db
      - smart-contracts-verifier
      - redis_db
    image: blockscout/blockscout:latest
    restart: unless-stopped
    container_name: blockscout
    stop_grace_period: 5m
    command: sh -c "bin/blockscout eval \"Elixir.Explorer.ReleaseTasks.create_and_migrate()\" && bin/blockscout start"
    environment:
      # Database configuration
      DATABASE_URL: postgresql://blockscout:blockscout@db:5432/blockscout
      ECTO_USE_SSL: "false"
      
      # Network configuration - Hardhat local network
      ETHEREUM_JSONRPC_VARIANT: geth
      ETHEREUM_JSONRPC_HTTP_URL: http://host.docker.internal:8545
      ETHEREUM_JSONRPC_WS_URL: ws://host.docker.internal:8545
      ETHEREUM_JSONRPC_TRACE_URL: http://host.docker.internal:8545
      
      # Chain configuration for Hardhat
      CHAIN_ID: 31337
      CHAIN_SPEC_PATH: ""
      COIN: ETH
      COIN_NAME: "Ethereum"
      
      # Cache configuration - optimized for dev
      CACHE_EXCHANGE_RATES_PERIOD: "3600"
      CACHE_TOTAL_GAS_USAGE_COUNTER_ENABLED: "false"
      CACHE_ADDRESS_WITH_BALANCES_UPDATE_INTERVAL: "3600"
      CACHE_BLOCKS_COUNTER_ENABLED: "false"
      CACHE_TXS_COUNTER_ENABLED: "false"
      
      # API configuration  
      API_V1_READ_METHODS_DISABLED: "false"
      API_V1_WRITE_METHODS_DISABLED: "false"
      DISABLE_WEBAPP: "false"
      DISABLE_READ_API: "false"
      DISABLE_WRITE_API: "false"
      DISABLE_INDEXER: "true"
      
      # Redis configuration
      REDIS_URL: redis://redis_db:6379
      
      # UI Configuration
      LOGO: /images/blockscout_logo.svg
      LOGO_FOOTER: /images/blockscout_logo.svg
      SHOW_OUTDATED_NETWORK_MODAL: "false"
      SUPPORTED_CHAINS: '[{"title": "Hardhat Local", "url": "http://localhost:4000"}]'
      
      # Smart contract verification
      MICROSERVICE_SC_VERIFIER_ENABLED: "true"
      MICROSERVICE_SC_VERIFIER_URL: http://smart-contracts-verifier:8050/
      MICROSERVICE_SC_VERIFIER_TYPE: sc_verifier
      
      # Visualizer microservice
      MICROSERVICE_VISUALIZE_SOL_ENABLED: "true"
      MICROSERVICE_VISUALIZE_SOL_URL: http://visualizer:8052/
      
      # Sig provider microservice  
      MICROSERVICE_SIG_PROVIDER_ENABLED: "true"
      MICROSERVICE_SIG_PROVIDER_URL: http://sig-provider:8054/
      
      # Admin panel
      ADMIN_PANEL_ENABLED: "true"
      
      # Other configurations
      BLOCKSCOUT_VERSION: v6.8.1
      RELEASE_VERSION: 6.8.1
      BLOCKSCOUT_HOST: 0.0.0.0
      BLOCKSCOUT_PROTOCOL: http
      SECRET_KEY_BASE: RMgI4C1HSkxsEjdhtGMfwAHfyT6CKWXOgzCboJflfSm4jeAlic52io05KB6mqzc5
      CHECK_ORIGIN: "false"
      PORT: 4000
      MAILER_SMTP_ENABLED: "false"
      BLOCK_TRANSFORMER: base
      
      # PharmaLedger specific
      APPS: explorer,block_scout_web
      NETWORK_NAME: "PharmaLedger Local Network"
      SUBNETWORK: "Hardhat"
      NETWORK_ICON: "_network_icon.html"
      HOMEPAGE_PLATE_BACKGROUND_COLOR: "rgb(46, 125, 50)"
      HOMEPAGE_PLATE_TEXT_COLOR: "white"
      
      # Indexer performance tuning for development - COMPLETELY DISABLED
      INDEXER_DISABLED: "true"
      INDEXER_BLOCK_INTERVAL: "99999999"
      INDEXER_RECEIPTS_BATCH_SIZE: "1"
      INDEXER_RECEIPTS_CONCURRENCY: "1"
      INDEXER_BLOCKS_BATCH_SIZE: "1"
      INDEXER_BLOCKS_CONCURRENCY: "1"
      BLOCK_CATCHUP_BATCH_SIZE: "1"
      BLOCK_CATCHUP_CONCURRENCY: "1"
      
      # Disable ALL fetchers and background processes
      INDEXER_DISABLE_BLOCK_REWARD_FETCHER: "true"
      INDEXER_DISABLE_COIN_BALANCE_FETCHER: "true"
      INDEXER_DISABLE_TOKEN_BALANCE_FETCHER: "true"
      INDEXER_DISABLE_EMPTY_BLOCKS_SANITIZER: "true"
      INDEXER_DISABLE_CATALOGED_TOKEN_UPDATER: "true"
      INDEXER_DISABLE_UNCATALOGED_TOKEN_BALANCE_FETCHER: "true"
      
      # Disable block catchup mechanism completely
      DISABLE_BLOCK_CATCH_UP: "true"
      DISABLE_CATCHUP_INDEXER: "true"
      INDEXER_CATCHUP_DISABLED: "true"
      
      # Additional fetchers to disable for dev environment
      INDEXER_DISABLE_PENDING_TRANSACTIONS_FETCHER: "true"
      INDEXER_DISABLE_INTERNAL_TRANSACTIONS_FETCHER: "true"
      INDEXER_DISABLE_TOKEN_INSTANCE_FETCHER: "true"
      INDEXER_DISABLE_TOKEN_INSTANCE_LEGACY_SANITIZER: "true"
      INDEXER_DISABLE_TOKEN_INSTANCE_SANITIZER: "true"
      
      # Disable real-time indexing for development
      DISABLE_REALTIME_INDEXER: "true"
      REALTIME_INDEXER: "false"
      INDEXER_REALTIME_DISABLED: "true"
      
      # Block processing limits - set to minimal
      BLOCK_CATCHUP_DELAY: "999999999"
      FIRST_BLOCK: "latest"
      LAST_BLOCK: "latest"
      INDEXER_START_BLOCK: "latest"
      INDEXER_CATCHUP_STARTING_BLOCK_SHIFT: "0"
      
      # Additional settings to prevent loops
      INDEXER_EMPTY_BLOCKS_SANITIZER_BATCH_SIZE: "1"
      INDEXER_TOKEN_BALANCES_BATCH_SIZE: "1"
      INDEXER_TOKEN_INSTANCES_SANITIZER_BATCH_SIZE: "1"

      # Disable SSL requirement for development
      FORCE_SSL: "false"
      
      # WebSocket configuration
      WEBSOCKET_V2_ENABLED: "true"
      
      # CORS configuration - FIXED
      ENABLE_CORS: "true"
      CORS_ALLOWED_ORIGINS: "http://localhost:3000"
      CORS_ALLOWED_HEADERS: "accept,accept-encoding,authorization,content-type,updated-gas-oracle,x-requested-with,access-control-allow-origin,access-control-allow-headers,access-control-allow-methods"

      CORS_ALLOWED_METHODS: "GET,POST,PUT,DELETE,OPTIONS"
      CORS_ALLOW_CREDENTIALS: "true"
      CORS_MAX_AGE: "86400"
      CORS_EXPOSED_HEADERS: "*"
      
      # Additional performance optimizations
      HEART_BEAT_TIMEOUT: "60000"
      HEART_COMMAND_TIMEOUT: "60000"
      
      # Indexer timing optimizations
      INDEXER_CATCHUP_BLOCKS_BATCH_SIZE: "1"
      INDEXER_CATCHUP_BLOCKS_CONCURRENCY: "1"
      INDEXER_MEMORY_LIMIT: "1000000000"
      
      # Logging level
      LOG_LEVEL: "warn"
      
      # Additional API settings to ensure compatibility
      API_V2_ENABLED: "true"
      API_RATE_LIMIT: "false"
      
    ports:
      - "4000:4000"
    volumes:
      - ./logs/:/opt/app/logs/
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Nginx Gateway - single entry point
  nginx:
    image: nginx:alpine
    container_name: gateway
    depends_on:
      - frontend
      - blockscout
    ports:
      - "3000:80"                # Toàn hệ thống truy cập qua http://localhost:3000
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - default

  # Frontend for Blockscout - internal only
  frontend:
    depends_on:
      - blockscout
    image: ghcr.io/blockscout/frontend:v1.29.0
    restart: unless-stopped
    container_name: frontend
    expose:
      - "3000"
    environment:
      # Required frontend variables
      NEXT_PUBLIC_APP_HOST: localhost
      NEXT_PUBLIC_APP_PORT: 3000
      NEXT_PUBLIC_APP_PROTOCOL: http
      
      # API configuration - ĐỔI các biến API để FE tự build URL cùng origin:
      NEXT_PUBLIC_API_HOST: localhost
      NEXT_PUBLIC_API_PORT: 3000
      NEXT_PUBLIC_API_PROTOCOL: http
      NEXT_PUBLIC_API_BASE_PATH: /api
      NEXT_PUBLIC_API_WEBSOCKET_PROTOCOL: ws
      
      # Network configuration
      NEXT_PUBLIC_NETWORK_NAME: "PharmaLedger Local"
      NEXT_PUBLIC_NETWORK_SHORT_NAME: "Hardhat"
      NEXT_PUBLIC_NETWORK_ID: 31337
      NEXT_PUBLIC_NETWORK_CURRENCY_NAME: ETH
      NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL: ETH
      NEXT_PUBLIC_NETWORK_CURRENCY_DECIMALS: 18
      NEXT_PUBLIC_IS_TESTNET: "true"
      
      # Additional required variables
      NEXT_PUBLIC_HOMEPAGE_CHARTS: '["daily_txs"]'
      NEXT_PUBLIC_HOMEPAGE_PLATE_TEXT_COLOR: "white"
      NEXT_PUBLIC_HOMEPAGE_PLATE_BACKGROUND: "rgb(46, 125, 50)"

volumes:
  postgres-data:
  redis-data: